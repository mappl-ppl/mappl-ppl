#!/usr/bin/perl
#
# Usage: pcfg-gen-dice $length $prob
#
# Generate a Dice program to compute the probability of string $length
# generated by the PCFG
#   S -> SS (probability $prob)
#   S -> a  (probability 1-$prob)

use strict;
my $length = $ARGV[0] // 6;
my $prob = $ARGV[1] // 0.9;
my $q = 1-$prob;

my $bits = 1; $bits++ until $length + 1 < 2 ** $bits;
my $fail = "int($bits," . ($length + 1) . ")";

print "fun A(i:int($bits)) { if i < int($bits,$length) then i + int($bits,1) else $fail }\n";
print "fun S0(i:int($bits)) { $fail }\n";

for (my $i = 0; $i < $length; $i++) {
  my $j = $i+1;
  print "fun S$j(i:int($bits)) { if flip $q then S$i(S$i(i)) else A(i) }\n";
}

print "S$length(int($bits,0)) == int($bits,$length)\n";
